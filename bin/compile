#!/bin/bash

set -e

BUILD_DIR=${1:-}
CACHE_DIR=${2:-}
ENV_DIR=${3:-}

basedir="$( cd -P "$( dirname "$0" )" && pwd )"
BUILDPACK_DIR="$(readlink -f ${basedir}/..)"

source ${BUILDPACK_DIR}/lib/common.sh

if [ -n "$BUILDPACK_DEBUG" ]; then
  set -x
fi

TEMPO_VERSION="${TEMPO_VERSION:-2.4.0}"

echo "-----> Buildpack Tempo v${TEMPO_VERSION}"

install_tempo() {
  local BUILD_DIR="${1}"
  local CACHE_DIR="${2}"

  tempo_dist="tempo-linux-amd64"
  tempo_archive="tempo-${TEMPO_VERSION}.linux-amd64.tar.gz"
  tempo_url="https://github.com/grafana/tempo/releases/download/v${TEMPO_VERSION}/${tempo_archive}"

  if [[ -f "$CACHE_DIR/.TEMPO_VERSION" ]]; then
    old_version=$(cat $CACHE_DIR/.TEMPO_VERSION)
    if [[ $old_version != $TEMPO_VERSION ]]; then
      echo "-----> Nouvelle version détectée"
      rm -f $CACHE_DIR/*.tar.gz
    fi
  fi

  if [[ ! -f "$CACHE_DIR/${tempo_archive}" ]]; then
    echo "-----> Téléchargement de Tempo ${TEMPO_VERSION}..."
    curl -L --retry 3 --retry-delay 2 -o ${CACHE_DIR}/${tempo_archive} "${tempo_url}"
    
    if [ ! -f "${CACHE_DIR}/${tempo_archive}" ]; then
      echo "ERREUR: Échec du téléchargement"
      exit 1
    fi
    
    echo $TEMPO_VERSION > ${CACHE_DIR}/.TEMPO_VERSION
    echo "       Téléchargement terminé"
  else
    echo "-----> Utilisation du cache"
  fi

  echo "-----> Extraction de Tempo..."
  mkdir -p "${BUILD_DIR}/tempo"
  
  # Extraire directement dans BUILD_DIR
  tar xzf ${CACHE_DIR}/${tempo_archive} -C ${BUILD_DIR}
  
  # Chercher l'exécutable dans différents endroits possibles
  if [ -f "${BUILD_DIR}/${tempo_dist}" ]; then
    echo "       Exécutable trouvé à la racine"
    mv "${BUILD_DIR}/${tempo_dist}" "${BUILD_DIR}/tempo/tempo"
  elif [ -f "${BUILD_DIR}/tempo-${TEMPO_VERSION}/${tempo_dist}" ]; then
    echo "       Exécutable trouvé dans le sous-dossier"
    mv "${BUILD_DIR}/tempo-${TEMPO_VERSION}/${tempo_dist}" "${BUILD_DIR}/tempo/tempo"
    rm -rf "${BUILD_DIR}/tempo-${TEMPO_VERSION}"
  else
    echo "ERREUR: Exécutable non trouvé"
    echo "Contenu de BUILD_DIR:"
    ls -la ${BUILD_DIR}/
    exit 1
  fi
  
  chmod +x "${BUILD_DIR}/tempo/tempo"
  echo "       Extraction terminée"
}

mkdir -p $CACHE_DIR
export_env_dir "$ENV_DIR"
install_tempo ${BUILD_DIR} ${CACHE_DIR}

echo "-----> Configuration de Tempo..."
mkdir -p ${BUILD_DIR}/tempo/etc

echo "-----> Copie des scripts..."
cp ${BUILDPACK_DIR}/opt/boot.sh ${BUILD_DIR}/
cp ${BUILDPACK_DIR}/opt/gen_tempo_conf.rb ${BUILD_DIR}/
cp ${BUILDPACK_DIR}/opt/tempo.yaml.erb ${BUILD_DIR}/

chmod +x ${BUILD_DIR}/boot.sh
chmod +x ${BUILD_DIR}/gen_tempo_conf.rb

export BUILDPACK_DIR

if [ -f "${BUILD_DIR}/tempo.yaml" ]; then
  echo "       Utilisation de tempo.yaml fourni"
  cp "${BUILD_DIR}/tempo.yaml" "${BUILD_DIR}/tempo/etc/tempo.yaml"
elif [ -n "$TEMPO_CONFIG_YAML" ]; then
  echo "       Utilisation de TEMPO_CONFIG_YAML"
  echo "$TEMPO_CONFIG_YAML" > "${BUILD_DIR}/tempo/etc/tempo.yaml"
else
  echo "       Génération de la configuration"
  ruby ${BUILD_DIR}/gen_tempo_conf.rb > "${BUILD_DIR}/tempo/etc/tempo.yaml"
fi

if [ ! -f "${BUILD_DIR}/tempo/etc/tempo.yaml" ]; then
  echo "ERREUR: Configuration non créée"
  exit 1
fi

echo "       Configuration créée"

rm -f ${BUILD_DIR}/gen_tempo_conf.rb ${BUILD_DIR}/tempo.yaml.erb

echo "-----> Buildpack Tempo installé!"