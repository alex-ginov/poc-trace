# Configuration serveur
# Note: http_listen_port sera override par boot.sh avec $PORT de Scalingo
server:
  http_listen_port: <%= server_config["http_listen_port"] %>
  grpc_listen_port: <%= server_config["grpc_listen_port"] %>

# Configuration du distributeur
distributor:
  receivers:
    otlp:
      protocols:
        grpc:
          endpoint: "0.0.0.0:4317"
        http:
          endpoint: "0.0.0.0:4318"

# Configuration de l'ingester
ingester:
  max_block_duration: <%= get_env("TEMPO_INGESTER_MAX_BLOCK_DURATION", "1h") %>
  max_block_bytes: <%= get_env("TEMPO_INGESTER_MAX_BLOCK_BYTES", "104857600") %>
  complete_block_timeout: <%= get_env("TEMPO_INGESTER_COMPLETE_BLOCK_TIMEOUT", "5m") %>

# Configuration du compacteur
compactor:
  compaction:
    block_retention: <%= get_env("TEMPO_COMPACTOR_BLOCK_RETENTION", "48h") %>

# Configuration du stockage
storage:
  # Configuration du backend de stockage des traces
  trace:
    backend: <%= storage_config.dig("trace", "backend") || 'local' %>
  
  # Configuration du Write-Ahead Log
  wal:
    path: <%= storage_config.dig("wal", "path") || '/tmp/tempo/wal' %>
  
  # Configuration du stockage local (si activé)
  <% if storage_config["local"] && storage_config["local"].is_a?(Hash) %>
  local:
    path: <%= storage_config["local"]["path"] || '/tmp/tempo/blocks' %>
  <% end %>
  
  # Configuration du stockage S3 (si activé)
  <% if storage_config["s3"] && storage_config["s3"].is_a?(Hash) %>
  s3:
    bucket: <%= storage_config.dig("s3", "bucket") %>
    <% if storage_config.dig("s3", "endpoint") %>
    endpoint: <%= storage_config["s3"]["endpoint"] %>
    <% end %>
    <% if ENV["TEMPO_STORAGE_S3_ACCESS_KEY_ID"] %>
    access_key_id: <%= ENV["TEMPO_STORAGE_S3_ACCESS_KEY_ID"] %>
    <% end %>
    <% if ENV["TEMPO_STORAGE_S3_SECRET_ACCESS_KEY"] %>
    secret_access_key: <%= ENV["TEMPO_STORAGE_S3_SECRET_ACCESS_KEY"] %>
    <% end %>
    insecure: <%= ENV["TEMPO_STORAGE_S3_INSECURE"]&.downcase == "true" || false %>
  <% end %>

# Configuration des métriques (optionnel)
metrics_generator:
  registry:
      source: tempo
      environment: <%= get_env("ENVIRONMENT", "production") %>